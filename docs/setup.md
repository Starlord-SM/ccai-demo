# Setup

## Assumptions

This guide assumes you have:

- Access to a Twilio Flex project with billing enabled
- Access to a GCP project with billing enabled
- Have set up a Dialogflow Agent on the above GCP project

## Fulfillment Function Setup

1. Go to [Firebase Console](https://console.firebase.google.com/) and click "Add project"

1. Select your GCP project from the list for "Project Name" and click "Continue"

1. Click "Confirm Plan"

1. Click "Continue"

1. Disable "Enable Google Analytics for this project" and click "Add Firebase"

1. Click "Continue"

1. Go to `src/fulfillment-function` and follow the `README.md` there, remembering to change the project ID in `.firebaserc`

1. Deploy your function by the command line

1. Go to "Functions" on the Firebase Console and confirm you can see your function has been uploaded. Make note of the URL it's generated.

Your fulfillment function is now configured.

## Dialogflow Agent Setup

1. Go to the [Dialogflow Console](https://dialogflow.cloud.google.com/)

1. Click the cog icon next to the project ID

1. Click "Export and Import", and choose "**Restore** from ZIP"

1. Upload the zip located at `src/dialogflow-agent/ccai-sandbox-agent.zip`

1. Type "RESTORE" in the text box that appears, and click "RESTORE"

1. Once you see the "Done" toast appear, you can close the modal

1. Click on "Fulfillment"

1. For the "Webhook" option, replace the value of "URL" which should be set to `https://YOUR.FULFILLMENT.URL.HERE` with the URL of the fulfillment function you just setup. It should end in `/syncTemplateDetector`.

1. Click "Save" at the bottom of the page

1. Use the "Try it now" box on the right, and type "Hello". Confirm you see the follow (especially note the inclusion of the `sync-attributes` context):

   - ![Dialogflow Test](./images/dialogflow-test.png)

### Request CCAI for your Dialogflow Agent project

To enable Agent Assist features, you must first request your Dialogflow Agent Project be whitelisted for the (currently beta) CCAI functionality. Fill out [this form](https://docs.google.com/forms/d/e/1FAIpQLSe2xMdpg_L2bhvl4EoNTUC4Nctzc3Qlw54uQ1_JNFgr0VhOfg/viewform) and wait for confirmation that you have been whitelisted before continuing. Once this is done, you can continue with the below steps.

1. Go to the [Dialogflow Console](https://dialogflow.cloud.google.com/)

1. Click the cog icon next to the project ID

1. Under "Beta Features", enable "Enable beta features and APIs"

1. Click "Save" at the top of the page

Dialogflow is now configured for CCAI.

## Twilio Setup

1. Go to [Assets](https://www.twilio.com/console/assets), and add all the contents of the `src/flex-plugins` folder. Make sure you upload them as private assets.

1. Go to [Flex](https://www.twilio.com/console/flex/overview) and click "Launch Flex".

1. Go to [Airline Manager](https://flex.twilio.com/airline-manager/) and confirm you can see the "Get started with CCAI" page:

   - ![CCAI Starter Pager Screenshot](./images/ccai-starter-page.png)

1. Enter the information as follows, and then click "Create":

   - **Project Name:** A unique alphanumeric name with no spaces. _ie: client-ccai-sandbox_
   - **Twilio Account SID:** This should already be filled out.
   - **Twilio Auth Token:** Go to [Console](https://www.twilio.com/console) and click "view" next to "Auth Token". Use this value. _ie: 29f4de1e9153481877b763ffe2d6d720_
   - **Twilio Phone Number:** Go to [Manage Numbers](https://www.twilio.com/console/phone-numbers/incoming) and copy the value of the phone number you wish to use, with no spaces. _ie: +12345678908_
   - **Google Cloud Project Name:** This is the Google Cloud Project alphanumeric ID generated by GCP. _ie: client-ccai-sandbox-acj_
   - **Google Cloud Project Keyfile:** Go to [IAM > Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts). Click the vertical "..." to the right of the service account with the name "Dialogflow Integrations", and click "Create Key", select "JSON", and click "Create". This will trigger a download to your computer. Upload this file as the value for this field.
   - **GCP Fulfillment Authentication File:** Not required for this setup.

1. Confirm you can see the Twilio CCAI Integration config homepage:

   - ![CCAI Homepage Screenshot](./images/ccai-home.png)

1. Click on the "Automation" tab, and confirm you can see "Incoming Webchat" and "Incoming Call" configured under "Automation Profiles > Quick Access"

1. Go to [Flex Homepage](https://flex.twilio.com/admin/) and click "Webchat > Launch" on the right-hand side.

1. Click "Chat with Us", send "hello", and confirm you get a small-talk response from Dialogflow:

   - ![Webchat Test](./images/webchat.png)

1. **Note:** To continue past this point you must have [requested and received confirmation that your Dialogflow Agent has been approved by Google to use CCAI](#request-ccai-for-your-dialogflow-agent-project).

1. Reach out to an Airline Engineer to enable CCAI for the Dialogflow Agent on the project you've just setup. They will need to both enable CCAI capability for the Dialogflow Agent, as well as actually turn it on. Confirm you can see the flag enabled:

   - ![CCAI Enabled Flag](./images/ccai-enabled.png)

1. Go to the "Configuration" tab and go into "Conversation Profiles", hit "Create"

1. Click "Add a Human Agent Assistant", enter the information as follows for the "Human Agent Suggestion", and hit "create":

   - **Name of Profile:** A unique alphanumeric name with no spaces. _ie: sandbox-cp_
   - **Dialogflow Agent ID:** The Dialogflow Agent you've added as part of the Airline setup process. _ie: client-ccai-sandbox-acj_
   - **Type of Suggestions:** Dialogflow Assist
   - **Related Dialogflow Agent:** The Dialogflow Agent you've added as part of the Airline setup process. _ie: client-ccai-sandbox-acj_
   - **Max Results:** 10
   - **Enable Inline Suggestion:** Enabled
   - **Enable Event Based Suggestion:** Disabled
   - **Trigger Model Mode:** None selected
   - **Group Suggestion Responses:** Disabled
   - **Enable Entity Extraction:** Disabled

1. Go back to "Automation > Automation Profile" and for both the "Incoming Webchat" and "Incoming Call":

   1. Select the "CCAI" option
   1. Choose your new conversation profile from the dropdown that appears. _ie: sandbox-cp_

Twilio is now configured.

## E2E Test

1. Go back to [Flex], and launch the webchat as before.

1. Ensure your user is set to `Available`

1. On the webchat, you should be able to have the following conversation:

   - Customer: Hello!
   - system: Welcome to your CCAI Sandbox! For information on how to configure this system, please see https://github.com/DVELP/ccai-wiki/wiki
   - Customer: I want a policy
   - system: I can help you with a new quote. Our Premium deals start at Â£50 per month.
   - Customer: What are my car details
   - system: The information we have on file is for a BMW 5 Series L with registration GX67 BLJ.
   - Customer: I want to speak to someone
   - system: Of course. Passing you through to one of our agents now.

1. A task should be available to accept on Flex - accept it, and confirm you can see the following:

   - ![Flex E2E Test](./images/flex-test.png)
   
1. With the above, you should be able to utter "speak to an agent" at any time, and the task be raised in Flex. Subsequent user utterances should then prompt a realtime update to the Dynamic Context Panel (the right-hand-side in the screenshot above).

You have confirmed the full system is working. Happy developing!
